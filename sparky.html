<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="myStyles.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed|Saira+Extra+Condensed" rel="stylesheet">
    <title>Sparky | Team Firework</title>
  </head>

  <body>
  	<!-- Page header -->
  	<div class="page-header">
  		<div class="container-fluid">
		<h1 align="center"><span style="color:#fad5a6"><b>Team Firework</b></span></h1>
		<h3 align="center"><span style="color:#fad5a6">Our Spunky Bot</span></h3>
		</div>
		<!--<div class="container" align="center">
			<audio src="audio/firework.mp3" loop="loop" controls controlsList="nodownload"><p>Oh no! You can't hear our music.</p></audio>
		</div>-->
  	</div>

  	<!-- Navigation bar -->
  	<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <!--<div class="container-fluid">
      <a href="#"><span class="glyphicon glyphicon-star-empty"></span></a>-->
  	  </div>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="sparky.html">Sparky</a></li>
        <li><a href="team.html">Team</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Assignments <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="lab1/lab1.html">Lab 1</a></li>
            <li><a href="lab2/lab2.html">Lab 2</a></li>
            <li><a href="lab3/lab3.html">Lab 3</a></li>
            <li><a href="lab4/lab4.html">Lab 4</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="milestone1/milestone1.html">Milestone 1</a></li>
            <li><a href="milestone2/milestone2.html">Milestone 2</a></li>
            <li><a href="milestone3/milestone3.html">Milestone 3</a></li>
            <li><a href="milestone3/milestone3.html">Milestone 4</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="ethics.html">Ethics HW</a></li>
            <li><a href="competition/competition.html">Final Competition!</a></li>
          </ul>
        </li>
        <li><a href="tutorials.html">Tutorials</a></li>
      </ul>
      <!--A search bar -->
      <!--<form class="navbar-form navbar-left">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
      </form>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
    
  <!--Page content -->
  <div class="body-content">
    <h1>Meet Sparky</h1>
		<p>Team Fireworks is very excited to introduce you with our lovely robot Sparky. Sparky can detect the 660Hz 
		  starting tone so as all three types of treasures, had one of if not the best System PCB (Kirstin said 
		  she love it) and won the fifth place in the 2017 ECE3400 Maze Mapping Robot Competition :D
	  	</p>  
    <img src="images/sparky.jpg">
	
	<hr>
  	<h1>System Design</h1>
    		<h3>System Electrical Components Breakdown</h3>
	  	<p>Here are the high level bullet listed view of all the electrical components Sparky used:
			<ul>
				<li><p>4 QRE1113 Line Sensors <a href="https://www.sparkfun.com/products/9453">[Sparkfun Link]</a></p></li>
					<ul>
						<li> <p>Two sensors in the middle are used for line following</p> </li>
						<li> <p>Two sensors at the left and right edge are used for turning and intersection detecting</p> </li>
	  				</ul>
				<li><p>3 IR Distance Sensors <a href="https://www.sparkfun.com/products/242">[Sparkfun Link]</a></p></li>
					<ul>
						<li> <p>One sensor for left wall detection, one for front, and one for right</p> </li>
	  				</ul>
				<li><p>2 Servo Motors <a href="https://www.parallax.com/downloads/continuous-rotation-servo-documentation">[Parallelx Link]</a></p></li>
					<ul>
						<li> <p>One motor for left wheel control and one for right wheel control</p> </li>
	  				</ul>
				<li><p>1 MAX4466 Microphone <a href="https://www.adafruit.com/product/1063">[Adafruit Link]</a></p></li>
					<ul>
						<li> <p>Used for starting tone detection</p> </li>
	  				</ul>
				<li><p>1 nRF24L01+ 2.4GHz Wireless Transceiver Radio <a href="http://www.elecfreaks.com/store/24g-wireless-nrf24l01p-rfm04-p-118.html">[ElecFreaks Link]</a></p></li>
					<ul>
						<li> <p>Used to transmit the maze exploration data from Sparky to the Fireworks Base Station</p> </li>
	  				</ul>
				<li><p>1 74HC4051 Multiplexer <a href="https://www.sparkfun.com/products/13906">[Sparkfun Link]</a></p></li>
					<ul>
						<li> <p>The Arduino Uno only had 6 analog input pins, but we need to use 8 pins (4 Line Sensors, 3 Wall Sensors, 1 Microphone). The multiplexer 74HC4051 allows us to use only one analog pin to read 3 wall sensor values by using 2 digital pins as signal select pins.</p> </li>
	  				</ul>
				<li><p>1 Arduino Uno <a href="https://www.sparkfun.com/products/11021">[Sparkfun Link]</a></p></li>
					<ul>
						<li><p> Sparky’s brain to be programmed to follow line, avoid wall, listen to tone, detect treasure, communicate through radio and explore the maze using DFS </p></li>
	  				</ul>
				<li><p>2 Treasure Detection Circuitry that we built using LF353 Op-amp <a href="http://www.ti.com/lit/ds/symlink/lf353-n.pdf">[Op-amp Datasheet Link]</a></p></li>
	  		</ul>
	  	</p>
	
		<hr>
    		<h3>System PCB</h3>
	  	<p> In this class, anything can go wrong will go wrong. Breadboard wirings are very prone to errors and it will go wrong:
			a simple loose wire can screw the entire system and it might waste teams tons of time to debug such small wire 
			loose issue. A System PCB is the way to go for robust system design, so we made a System PCB for Sparky. 
			It basically condenses most of wirings to the PCB and gets rid of all the crazy nasty breadboard wirings. 
			It has plugs for every electrical component and plugs are placed based on the actual position of the component
			in the robot. On the PCB, each plug has three vias, two vias connected to power and ground and the other via 
			is connected to the corresponding signal pin of the Arduino based on our Final Arduino Pin Assignment Table. 
			(A 0.1uF decoupling capacitor is also placed directly next to each sensor to minimize noise from power bank 
			and servo.) We then soldered 3x1 female pin header to the plug position of the PCB and also soldered male pin 
			header to the three sensor wires. Now connecting the sensors to the system would simply be an easy snap and 
			plug and it works like a charm :D. 
		</p>
		<p>
		<table> 
		 	<tr>
		    		<td width="56%"><img src="final_robot_design/PCB_Comment.png"></td>
		    		<td width="44%"><img src="final_robot_design/PCB.png"></td>
		  	</tr>
			<tr>
				<td text-align="center" width="56%"><p>Eagle PCB Design with Comment</p></td>
				<td text-align="center" width="44%"><p>Fabricated PCB</p></td>
		  	</tr>
		</table>
		<img src="final_robot_design/Schematics.png" text-align="center" class="center_picture">
		<p text-align="center">Eagle Schematics</p>
		<img src="final_robot_design/Arduino_Pin_Table.png" text-align="center" class="center_picture">
		<p text-align="center">Arduino Pin Assignment Table</p>
		</p>
	
		<br>
		<p> Some thoughts for future improvements: 1. The long female pin header went out in the lab when the PCB came in, 
			so we soldered the short female pin header on the board instead. We learned that the short female pin header 
			doesn’t have a robust hold of the male pin connector. We should have re-soldered the long female pin header to 
			the board to make our system more robust. 2. The PCB is very compact and this results in pin connectors blocking 
			other pin connectors for the microphone circuitry and radio circuitry. We hacked and resolved the issue by stacking 
			pin headers on top of pin headers to create more room. What we could have done differently in designing is to extend 
			the PCB to make it bigger and more spread out to create more room. It might also be cool to create some good mounting 
			structures on the PCB for microphone, treasure circuitries. Lastly, our design is based off Adafruit’s open source 
			Proto Shield Design <a href="https://www.adafruit.com/product/2077?gclid=EAIaIQobChMInam-5qrz1wIVVbjACh1IMAF9EAQYASABEgL4efD_BwE">[link]</a> and 
			we reused its already well aligned digital and analog pin vias, so as Sparkfun’s mux aligned pin out. 
			We would like to thank Adafruit and sparkfun for this and are as well open sourcing our design to contribute back 
			to the open source community. Here is the <a href="final_robot_design/Fireworks_PCB_1.1.sch">[link] to our Schematics</a> and 
			here is the <a href="final_robot_design/Fireworks_PCB_1.1.brd">[link] to the PCB</a>.
		</p>
		
		<hr>
		<h3>System Power Analysis</h3>
		<p> We did a thorough System Power Analysis by going through the data sheet of each component and making sure each 
			is powered at the correct operating voltage.</p> 
		<img src="final_robot_design/Power_Analysis.png" text-align="center">
		<br>
		<p> We also calculated the total current drawn for each power source and made sure each power source can handle the current load.</p>
			<ul>
				<li> <p>For the 5V power bank, five components are drawing roughly 484mA of current, which is less 
					than the max 1A outputting current of the power bank. The power bank is rated as 5000mAH, 
					but in practice, it has some internal protection circuitry to prevent the battery from being
					drawn below 20% of its capacity to avoid permanently damaging the battery inside. This leaves
					us 4000mAH in practice. 4000mAH/484mA gives us roughly 8 hours of run time.</p> </li>
				<li> <p>For the 3.3V Arduino power supply, two components are drawing below 1mA from the arduino with
					temporary surge to ~11mA during radio transmission, which is still less than the max 200mA 
					outputting current from the 3.3V Arduino power supply. </p> </li>
				<li> <p>For the 9V battery supply, the Arduino Uno is drawing about 50mA of current, which is less 
					than the max hundreds mA outputting current of the battery pack. A typical 9V battery pack 
					has about 400mAH usable capacity, which translates to 400mAH/50mA roughly 8 hours of run time.</p> </li>
			</ul>
		
		<hr>
		<h3>System Cost Breakdown Table</h3>
		<img src="final_robot_design/Robot_Cost.png" text-align="center">
		
		<hr>
		<h1>Schmitt Trigger Treasure Circuit In Depth Talk</h1>
		<p>The treasure circuit was a success and we finally freed ourselves from the cumbersome FFT algorithm. 
			Our final treasure detection system uses a schmitt trigger and feeds into a digital pin on the 
			Arduino with interrupts enabled such that we can detect the time between rising edges of the 
			blinking treasure sensor (the period) and use that to determine if we found a treasure and what 
			kind. One of the problems we had to consider with this approach is that voltage spikes could trigger 
			the interrupt and, if by coincidence the spikes occur at the right times, we could falsely detect a 
			treasure. The fix we used for this is to detect the frequency 255 times before registering it as a 
			treasure. The code example below applies to detecting 7kHz treasures with a print statement for debug.</p>
		
		<p> <pre>
<font color="#00979c">bool</font> <font color="#000000">treasureFound</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
<font color="#00979c">uint8_t</font> <font color="#000000">treasure7</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>

<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">period</font> <font color="#434f54">&gt;</font> <font color="#000000">130</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">period</font> <font color="#434f54">&lt;</font> <font color="#000000">150</font> <font color="#434f54">&amp;&amp;</font> <font color="#434f54">!</font><font color="#000000">treasureFound</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">numTreasures</font> <font color="#434f54">&lt;</font> <font color="#000000">3</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">treasure7</font> <font color="#434f54">==</font> <font color="#000000">255</font><font color="#000000">)</font> <font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<b><font color="#d35400">Serial</font></b><font color="#434f54">.</font><font color="#d35400">println</font><font color="#000000">(</font><font color="#005c5f">&#34;7kHz Treasure&#34;</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">treasureFound</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">treasure7</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">numTreasures</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;<font color="#000000">}</font>
 &nbsp;<font color="#000000">treasure7</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;<font color="#000000">period</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
<font color="#000000">}</font>
		</pre>
		</p>

		<p>We also integrated conditions that only one treasure can be found per intersection and that there will be a maximum of 3 treasures per maze.</p>
		<p>The circuit diagram shown below consists of four stages. The first stage is the treasure circuit from lab 2 
			which allows for a signal to be generated from a treasure. The next stage is a high pass filter to remove 
			the DC offset from the signal. We found that the DC offset varies greatly with the amount of sunlight and 
			fluorescent light incident to the sensor. The third stage is a simple non-inverting amplifier which amplifies 
			our signal by a factor of 5 so that less precision will be required by our schmitt trigger. The last stage is 
			the schmitt trigger itself. The threshold was set to be about 640 mV, a value determined by measuring the 
			output of the amplifier. We ended up having to tune this value quite a bit. Also, we originally had much 
			lower resistor values until we realized that low resistor values drew too much current and drained our 
			battery too quickly. The schmitt trigger worked well, but the range was limited by the open-loop performance 
			of the op amp used at higher frequencies. For 17kHz treasures, our range was much less than for 7kHz due 
			to the schmitt trigger taking time to resolve to a value relative to the time it takes the treasure to blink 
			on and off. This issue did not end up being significant, however, once we adjusted our threshold to the optimal
			point.</p>

		<img src="final_robot_design/Treasure_Circuit.png" text-align="center"></td>
		<p align="center">Treasure Circuit Schematics</p>
		<img src="final_robot_design/Treasure_Mount.png" text-align="center">
		<p align="center">Treasure Mount on Sparky</p>
  </div>

    <!-- Footer -->
    <div id="footer">
      <div class="container">
        <p class="muted credit" align="center">Brought to you by Team Firework. Have an explosive day!</p>
      </div>
    </div>

    <!-- Bootstrap core JavaScript -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


  </body>

</html>
